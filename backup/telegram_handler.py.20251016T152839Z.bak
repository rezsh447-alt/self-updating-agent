import os, json, glob, shutil, re
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes
from self_editor import append_snippet, safe_replace_in_file
from github_updater import git_commit_and_push

with open("config.json","r",encoding="utf-8") as f:
    CFG = json.load(f)

ADMIN_ID = str(os.getenv("ADMIN_ID") or CFG.get("ADMIN_ID",""))

# Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
USER_STATES = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.message.from_user.id)
    if user_id != ADMIN_ID:
        await update.message.reply_text("âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒ.")
        return
    
    keyboard = [
        [InlineKeyboardButton("ğŸ“ Ø§ÙØ²ÙˆØ¯Ù† snippet", callback_data="mode_snippet")],
        [InlineKeyboardButton("ğŸ”§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ú©Ø¯", callback_data="mode_replace")],
        [InlineKeyboardButton("âŒ Ù„ØºÙˆ Ø­Ø§Ù„Øª", callback_data="cancel_mode")]
    ]
    await update.message.reply_text(
        "ğŸ¤– Self-Updating Agent\n\n"
        "Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.message.from_user.id)
    if user_id != ADMIN_ID:
        await update.message.reply_text("âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒ.")
        return

    text = update.message.text.strip()
    
    # Ø¯Ø³ØªÙˆØ±Ø§Øª Ù„ØºÙˆ
    if text.lower() in ['cancel', 'exit', 'Ù„ØºÙˆ', 'Ø®Ø±ÙˆØ¬']:
        USER_STATES[user_id] = None
        await update.message.reply_text("âœ… Ø­Ø§Ù„Øª ÙˆÛŒÚ˜Ù‡ Ù„ØºÙˆ Ø´Ø¯.")
        return

    # Ø­Ø§Ù„Øª snippet
    if USER_STATES.get(user_id) == 'snippet':
        await handle_snippet_mode(update, text)
        return
    
    # Ø­Ø§Ù„Øª replace
    if USER_STATES.get(user_id) == 'replace':
        await handle_replace_mode(update, text)
        return

    # ÙØ±Ù…Øª Ù‚Ø¯ÛŒÙ…ÛŒ Ø¨Ø±Ø§ÛŒ backward compatibility
    if text.startswith("add_snippet::"):
        await handle_legacy_snippet(update, text)
        return
    
    # Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø­Ø§Ù„ØªÛŒ ÙØ¹Ø§Ù„ Ù†Ø¨ÙˆØ¯
    await update.message.reply_text(
        "Ù„Ø·ÙØ§Ù‹ Ø§ÙˆÙ„ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ ÛŒÚ© Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:\n"
        "/start - Ù†Ù…Ø§ÛŒØ´ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ"
    )

async def handle_snippet_mode(update: Update, text: str):
    """Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§Ù„Øª Ø§ÙØ²ÙˆØ¯Ù† snippet"""
    try:
        parts = text.split('\n')
        if len(parts) < 3:
            await update.message.reply_text(
                "âŒ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª!\n\n"
                "ÙØ±Ù…Øª ØµØ­ÛŒØ­:\n"
                "ÙØ§ÛŒÙ„\n"
                "Ù…Ø§Ø±Ú©Ø±\n"
                "Ú©Ø¯\n\n"
                "Ù…Ø«Ø§Ù„:\n"
                "telegram_handler.py\n"
                "# KEYBOARD_MARKER\n"
                "InlineKeyboardButton('ğŸ® Ø¨Ø§Ø²ÛŒ', callback_data='play')"
            )
            return
        
        file, marker, snippet = parts[0], parts[1], '\n'.join(parts[2:])
        res = append_snippet(file, marker, snippet)
        
        if res["changed"]:
            kb = [
                [InlineKeyboardButton("âœ… Commit & Push", callback_data=f"push::{file}")],
                [InlineKeyboardButton("âŒ Revert", callback_data=f"revert::{file}")],
                [InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="back_to_menu")]
            ]
            await update.message.reply_text(
                f"âœ… ØªØºÛŒÛŒØ± Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯!\n"
                f"ğŸ“ ÙØ§ÛŒÙ„: {file}\n"
                f"ğŸ’¾ Ø¨Ú©Ø§Ù¾: {res['backup']}\n\n"
                "Ø¢ÛŒØ§ commit & push Ú©Ù†Ù…ØŸ",
                reply_markup=InlineKeyboardMarkup(kb)
            )
        else:
            await update.message.reply_text("â„¹ï¸ ØªØºÛŒÛŒØ± Ø§Ø¹Ù…Ø§Ù„ Ù†Ø´Ø¯ ÛŒØ§ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨ÙˆØ¯.")
        
        USER_STATES[str(update.message.from_user.id)] = None
        
    except Exception as e:
        await update.message.reply_text(f"âŒ Ø®Ø·Ø§: {e}")

async def handle_replace_mode(update: Update, text: str):
    """Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§Ù„Øª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ú©Ø¯"""
    try:
        parts = text.split('\n')
        if len(parts) < 3:
            await update.message.reply_text(
                "âŒ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª!\n\n"
                "ÙØ±Ù…Øª ØµØ­ÛŒØ­:\n"
                "ÙØ§ÛŒÙ„\n"
                "Ø§Ù„Ú¯Ùˆ\n"
                "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†\n\n"
                "Ù…Ø«Ø§Ù„:\n"
                "telegram_handler.py\n"
                "async def start.*?await update\\.message\\.reply_text\\(\"Ø³Ù„Ø§Ù…\"\\)\n"
                "async def start(update, context):\\n    await update.message.reply_text(\"Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯\")"
            )
            return
        
        file, pattern, replacement = parts[0], parts[1], '\n'.join(parts[2:])
        res = safe_replace_in_file(file, pattern, replacement)
        
        if res["changed"]:
            kb = [
                [InlineKeyboardButton("âœ… Commit & Push", callback_data=f"push::{file}")],
                [InlineKeyboardButton("âŒ Revert", callback_data=f"revert::{file}")],
                [InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="back_to_menu")]
            ]
            await update.message.reply_text(
                f"âœ… Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!\n"
                f"ğŸ“ ÙØ§ÛŒÙ„: {file}\n"
                f"ğŸ’¾ Ø¨Ú©Ø§Ù¾: {res['backup']}\n\n"
                "Ø¢ÛŒØ§ commit & push Ú©Ù†Ù…ØŸ",
                reply_markup=InlineKeyboardMarkup(kb)
            )
        else:
            await update.message.reply_text("â„¹ï¸ Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ù†Ø´Ø¯ (Ø§Ù„Ú¯Ùˆ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯).")
        
        USER_STATES[str(update.message.from_user.id)] = None
        
    except Exception as e:
        await update.message.reply_text(f"âŒ Ø®Ø·Ø§: {e}")

async def handle_legacy_snippet(update: Update, text: str):
    """Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² ÙØ±Ù…Øª Ù‚Ø¯ÛŒÙ…ÛŒ"""
    try:
        _, file, marker, snippet = text.split("::", 3)
        res = append_snippet(file, marker, snippet)
        
        if res["changed"]:
            kb = [
                [InlineKeyboardButton("âœ… Commit & Push", callback_data=f"push::{file}")],
                [InlineKeyboardButton("âŒ Revert", callback_data=f"revert::{file}")]
            ]
            await update.message.reply_text(
                f"ØªØºÛŒÛŒØ± Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯ Ùˆ Ø¨Ú©Ø§Ù¾ Ø¯Ø± {res['backup']} Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯. Ø¢ÛŒØ§ commit & push Ú©Ù†Ù…ØŸ",
                reply_markup=InlineKeyboardMarkup(kb)
            )
        else:
            await update.message.reply_text("ØªØºÛŒÛŒØ± Ø§Ø¹Ù…Ø§Ù„ Ù†Ø´Ø¯ ÛŒØ§ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨ÙˆØ¯.")
            
    except Exception as e:
        await update.message.reply_text(f"Ø®Ø·Ø§: {e}")

async def callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    user_id = str(query.from_user.id)
    
    if user_id != ADMIN_ID:
        await query.edit_message_text("âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.")
        return
    
    if data == "mode_snippet":
        USER_STATES[user_id] = 'snippet'
        await query.edit_message_text(
            "ğŸ“ Ø­Ø§Ù„Øª Ø§ÙØ²ÙˆØ¯Ù† snippet ÙØ¹Ø§Ù„ Ø´Ø¯\n\n"
            "Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ Ø§ÛŒÙ† ÙØ±Ù…Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†:\n"
            "ÙØ§ÛŒÙ„\n"
            "Ù…Ø§Ø±Ú©Ø±\n"
            "Ú©Ø¯\n\n"
            "Ù…Ø«Ø§Ù„:\n"
            "telegram_handler.py\n"
            "# KEYBOARD_MARKER\n"
            "InlineKeyboardButton('ğŸ® Ø¨Ø§Ø²ÛŒ', callback_data='play')\n\n"
            "Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ: cancel"
        )
    
    elif data == "mode_replace":
        USER_STATES[user_id] = 'replace'
        await query.edit_message_text(
            "ğŸ”§ Ø­Ø§Ù„Øª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ú©Ø¯ ÙØ¹Ø§Ù„ Ø´Ø¯\n\n"
            "Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ Ø§ÛŒÙ† ÙØ±Ù…Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†:\n"
            "ÙØ§ÛŒÙ„\n"
            "Ø§Ù„Ú¯Ùˆ\n"
            "Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†\n\n"
            "Ù…Ø«Ø§Ù„:\n"
            "telegram_handler.py\n"
            "async def start.*?await update\\.message\\.reply_text\\(\"Ø³Ù„Ø§Ù…\"\\)\n"
            "async def start(update, context):\\n    await update.message.reply_text(\"Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯\")\n\n"
            "Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ: cancel"
        )
    
    elif data == "cancel_mode":
        USER_STATES[user_id] = None
        await query.edit_message_text("âœ… Ø­Ø§Ù„Øª ÙˆÛŒÚ˜Ù‡ Ù„ØºÙˆ Ø´Ø¯.")
    
    elif data == "back_to_menu":
        USER_STATES[user_id] = None
        keyboard = [
            [InlineKeyboardButton("ğŸ“ Ø§ÙØ²ÙˆØ¯Ù† snippet", callback_data="mode_snippet")],
            [InlineKeyboardButton("ğŸ”§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ú©Ø¯", callback_data="mode_replace")],
            [InlineKeyboardButton("âŒ Ù„ØºÙˆ Ø­Ø§Ù„Øª", callback_data="cancel_mode")]
        ]
        await query.edit_message_text(
            "ğŸ¤– Self-Updating Agent\n\n"
            "Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    
    elif data.startswith("push::"):
        file = data.split("::",1)[1]
        await query.edit_message_text("â³ Ø¯Ø± Ø­Ø§Ù„ commit Ùˆ push ...")
        result = git_commit_and_push(commit_message=f"agent: edit {file}", auto_push=True)
        if result.get("ok"):
            await query.edit_message_text(f"âœ… ØªØºÛŒÛŒØ±Ø§Øª push Ø´Ø¯!\n{result.get('message','')}")
        else:
            await query.edit_message_text(f"âŒ Ø®Ø·Ø§ Ø¯Ø± push:\n{str(result.get('error'))}")
    
    elif data.startswith("revert::"):
        file = data.split("::",1)[1]
        b = glob.glob("backup/" + os.path.basename(file) + ".*.bak")
        if not b:
            await query.edit_message_text("âŒ Ù‡ÛŒÚ† Ø¨Ú©Ø§Ù¾ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return
        latest = sorted(b)[-1]
        shutil.copy2(latest, file)
        await query.edit_message_text(f"âª ÙØ§ÛŒÙ„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯ Ø§Ø² {latest}")

def run_bot():
    token = os.getenv("TELEGRAM_TOKEN")
    if not token:
        raise RuntimeError("Set TELEGRAM_TOKEN env var")
    app = ApplicationBuilder().token(token).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.add_handler(CallbackQueryHandler(callback_handler))
    app.run_polling()

print("âœ… Ø§ÛŒÙ† ØªØºÛŒÛŒØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ù‡ Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ù¾ÙˆØ´ Ø´Ø¯!")
print("ğŸš€ ØªØ³Øª Ø¯ÙˆÙ… Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ² Ø¨ÙˆØ¯!")
from ai_agent import ai_agent, AIAgent
async def ai_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.message.from_user.id)
    if user_id != ADMIN_ID:
        await update.message.reply_text("âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±ÛŒ.")
        return
    
    user_command = update.message.text.strip()
    
    if user_command.startswith("/ai "):
        command = user_command[4:].strip()
        await update.message.reply_text(f"ğŸ¤” Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙˆØ±: {command}")
        
        # ØªØ­Ù„ÛŒÙ„ Ø¯Ø³ØªÙˆØ± ØªÙˆØ³Ø· AI
        ai_response = ai_agent.analyze_command(command)
        
        try:
            # Ù¾Ø§Ø±Ø³ Ú©Ø±Ø¯Ù† Ù¾Ø§Ø³Ø® AI
            lines = ai_response.strip().split('\n')
            file_name, marker, code = None, None, None
            
            for line in lines:
                if line.startswith("FILE:"):
                    file_name = line.split("FILE:")[1].strip()
                elif line.startswith("MARKER:"):
                    marker = line.split("MARKER:")[1].strip()
                elif line.startswith("CODE:"):
                    code = line.split("CODE:")[1].strip()
            
            if file_name and marker and code:
                # Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª
                res = append_snippet(file_name, marker, code)
                
                if res["changed"]:
                    # Ú©Ø§Ù…ÛŒØª Ùˆ Ù¾ÙˆØ´
                    result = git_commit_and_push(commit_message=f"ai: {command}", auto_push=True)
                    
                    if result.get("ok"):
                        await update.message.reply_text(
                            f"âœ… Ø¯Ø³ØªÙˆØ± AI Ø§Ø¬Ø±Ø§ Ø´Ø¯!\\n"
                            f"ğŸ“ ÙØ§ÛŒÙ„: {file_name}\\n"
                            f"ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø±ÛŒØ³ØªØ§Ø±Øª...\\n\\n"
                            f"Ù¾Ø§Ø³Ø® AI: {ai_response}"
                        )
                        
                        # Ø±ÛŒØ³ØªØ§Ø±Øª Ø®ÙˆØ¯Ú©Ø§Ø±
                        import sys
                        import os
                        os.execv(sys.executable, [sys.executable] + sys.argv)
                    else:
                        await update.message.reply_text(f"âŒ Ø®Ø·Ø§ Ø¯Ø± push: {result.get('error')}")
                else:
                    await update.message.reply_text("â„¹ï¸ ØªØºÛŒÛŒØ± Ø§Ø¹Ù…Ø§Ù„ Ù†Ø´Ø¯ ÛŒØ§ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨ÙˆØ¯.")
            else:
                await update.message.reply_text(f"âŒ Ù¾Ø§Ø³Ø® AI Ù†Ø§Ù…Ø¹ØªØ¨Ø±: {ai_response}")
                
        except Exception as e:
            await update.message.reply_text(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ± AI: {e}")
    
    else:
        await update.message.reply_text(
            "ğŸ¤– Ø¯Ø³ØªÙˆØ± AI\\n\\n"
            "ÙØ±Ù…Øª: /ai [Ø¯Ø³ØªÙˆØ±]\\n\\n"
            "Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§:\\n"
            "/ai Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØª\\n"  
            "/ai Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª\\n"
            "/ai Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ù†ÙˆÛŒ Ø¬Ø¯ÛŒØ¯"
        )
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, ai_command))